#!/bin/bash
# Cloudflare éƒ¨ç½²è„šæœ¬

set -e

echo "ğŸš€ å¼€å§‹éƒ¨ç½²è‚¡å¸‚ç›‘æ§ç³»ç»Ÿåˆ° Cloudflare"

# æ£€æŸ¥ wrangler æ˜¯å¦å®‰è£…
if ! command -v wrangler &> /dev/null; then
    echo "âŒ Wrangler CLI æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…:"
    echo "npm install -g wrangler"
    exit 1
fi

# æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
if ! wrangler whoami &> /dev/null; then
    echo "ğŸ” è¯·å…ˆç™»å½• Cloudflare:"
    wrangler login
fi

echo "ğŸ“ åˆ‡æ¢åˆ°éƒ¨ç½²ç›®å½•..."
cd "$(dirname "$0")"

# åˆ›å»º D1 æ•°æ®åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
echo "ğŸ—„ï¸  åˆ›å»º D1 æ•°æ®åº“..."
DATABASE_ID=$(wrangler d1 create stock-monitor-db --json | jq -r '.result.id')

if [ -z "$DATABASE_ID" ] || [ "$DATABASE_ID" = "null" ]; then
    echo "âŒ åˆ›å»º D1 æ•°æ®åº“å¤±è´¥"
    exit 1
fi

echo "âœ… D1 æ•°æ®åº“åˆ›å»ºæˆåŠŸï¼ŒID: $DATABASE_ID"

# æ›´æ–° wrangler.toml ä¸­çš„æ•°æ®åº“ ID
sed -i.bak "s/database_id = \"\"/database_id = \"$DATABASE_ID\"/" wrangler.toml

# åˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æ„
echo "ğŸ”§ åˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æ„..."
wrangler d1 execute stock-monitor-db --file=../sql/init.sql

# è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆéœ€è¦ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥ï¼‰
echo "ğŸ”‘ è®¾ç½®ç¯å¢ƒå˜é‡..."
echo "è¯·è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š"

read -p "ğŸ“§ å‘é€è€…é‚®ç®±: " SENDER_EMAIL
read -s -p "ğŸ” é‚®ç®±å¯†ç /æˆæƒç : " EMAIL_PASSWORD
echo
read -p "ğŸ“¨ æ¥æ”¶è€…é‚®ç®±: " RECIPIENT_EMAIL
read -p "ğŸ·ï¸  Cloudflare Account ID: " CF_ACCOUNT_ID
read -s -p "ğŸ”‘ Cloudflare API Token: " CF_API_TOKEN
echo

# è®¾ç½® secrets
wrangler secret put EMAIL_PASSWORD <<< "$EMAIL_PASSWORD"
wrangler secret put CF_API_TOKEN <<< "$CF_API_TOKEN"
wrangler secret put SENDER_EMAIL <<< "$SENDER_EMAIL"
wrangler secret put RECIPIENT_EMAIL <<< "$RECIPIENT_EMAIL"
wrangler secret put CF_ACCOUNT_ID <<< "$CF_ACCOUNT_ID"
wrangler secret put CF_DATABASE_ID <<< "$DATABASE_ID"

# éƒ¨ç½² Worker
echo "ğŸš€ éƒ¨ç½² Worker..."
wrangler deploy

echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo "ğŸŒ Worker URL: https://stock-monitor-api.your-subdomain.workers.dev"
echo ""
echo "ä¸‹ä¸€æ­¥ï¼š"
echo "1. éƒ¨ç½²å‰ç«¯åˆ° Cloudflare Pages"
echo "2. é…ç½®è‡ªå®šä¹‰åŸŸåï¼ˆå¯é€‰ï¼‰"
echo "3. æµ‹è¯• API ç«¯ç‚¹"