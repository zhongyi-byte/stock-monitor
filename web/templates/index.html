<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股市监控系统</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Chart.js for potential future charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Custom gradient and animations */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .demo-pulse {
            animation: pulse 2s infinite;
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div id="app">
        <!-- Header -->
        <div class="container mx-auto px-4 py-6">
            <div class="text-center text-white mb-8">
                <h1 class="text-4xl md:text-5xl font-bold mb-4">
                    📈 股市监控系统
                </h1>
                <p class="text-lg opacity-90">
                    实时监控美股、港股、比特币价格变动
                </p>
                <div class="mt-4 text-sm opacity-75">
                    <span v-if="lastUpdate">最后更新: {{ lastUpdate }}</span>
                    <span v-if="loading" class="ml-4">
                        <svg class="inline w-4 h-4 loading-spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        更新中...
                    </span>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-8">
                <div class="bg-white rounded-xl p-4 md:p-6 text-center card-hover">
                    <h3 class="text-gray-600 text-sm font-medium uppercase tracking-wide mb-2">总策略数</h3>
                    <div class="text-3xl font-bold text-blue-600">{{ stats.total || 0 }}</div>
                </div>
                
                <div class="bg-white rounded-xl p-4 md:p-6 text-center card-hover">
                    <h3 class="text-gray-600 text-sm font-medium uppercase tracking-wide mb-2">活跃策略</h3>
                    <div class="text-3xl font-bold text-green-600">{{ stats.active || 0 }}</div>
                </div>
                
                <div class="bg-white rounded-xl p-4 md:p-6 text-center card-hover">
                    <h3 class="text-gray-600 text-sm font-medium uppercase tracking-wide mb-2">已触发</h3>
                    <div class="text-3xl font-bold text-red-600">{{ stats.triggered || 0 }}</div>
                </div>
                
                <div class="bg-white rounded-xl p-4 md:p-6 text-center card-hover">
                    <h3 class="text-gray-600 text-sm font-medium uppercase tracking-wide mb-2">监控股票</h3>
                    <div class="text-3xl font-bold text-purple-600">{{ stats.symbols || 0 }}</div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Strategies Panel -->
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-4">
                        <h2 class="text-xl font-bold flex items-center">
                            🎯 当前监控策略
                            <span v-if="strategies.length" class="ml-2 bg-blue-400 text-xs px-2 py-1 rounded-full">
                                {{ strategies.length }}
                            </span>
                        </h2>
                    </div>
                    
                    <div class="p-6 max-h-96 overflow-y-auto custom-scrollbar">
                        <div v-if="strategies.length" class="space-y-4">
                            <div v-for="strategy in strategies" :key="strategy.id" 
                                 class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow"
                                 :class="{'bg-yellow-50 border-yellow-200': isDemo(strategy)}">
                                
                                <!-- Strategy Header -->
                                <div class="flex items-start justify-between mb-3">
                                    <h4 class="font-semibold text-gray-800 flex-1">{{ strategy.name }}</h4>
                                    <div class="flex items-center space-x-2">
                                        <span :class="getBadgeClass(strategy.action)" 
                                              class="px-2 py-1 rounded text-xs font-bold uppercase">
                                            {{ strategy.action }}
                                        </span>
                                        <span class="font-bold text-gray-700">{{ strategy.symbol }}</span>
                                    </div>
                                </div>
                                
                                <!-- Condition -->
                                <div class="text-sm text-gray-600 mb-3">
                                    <span v-if="strategy.condition_type === 'below'">
                                        价格低于 <span class="font-semibold">{{ formatPrice(strategy.target_price) }}</span> 时触发
                                    </span>
                                    <span v-else>
                                        价格高于 <span class="font-semibold">{{ formatPrice(strategy.target_price) }}</span> 时触发
                                    </span>
                                </div>
                                
                                <!-- Current Price -->
                                <div class="bg-gray-50 rounded-lg p-3 border-l-4"
                                     :class="isDemo(strategy) ? 'border-yellow-400 bg-yellow-50' : 'border-blue-400'">
                                    <div v-if="strategy.current_price" class="flex items-center justify-between">
                                        <div class="flex items-center space-x-2">
                                            <span class="text-sm text-gray-600">📊 当前价格:</span>
                                            <span class="font-bold" 
                                                  :class="isDemo(strategy) ? 'text-yellow-700' : 'text-green-600'">
                                                {{ strategy.currency }} {{ formatPrice(strategy.current_price) }}
                                            </span>
                                            <span v-if="isDemo(strategy)" 
                                                  class="bg-yellow-500 text-white px-2 py-0.5 rounded text-xs font-bold demo-pulse">
                                                演示数据
                                            </span>
                                        </div>
                                        <div v-if="strategy.last_updated" class="text-xs text-gray-500">
                                            {{ formatTimestamp(strategy.last_updated) }}
                                        </div>
                                    </div>
                                    <div v-else class="text-red-600 text-sm italic">
                                        🔄 价格获取中...
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div v-else class="text-center py-12">
                            <div class="text-gray-400 text-6xl mb-4">📊</div>
                            <p class="text-gray-600 text-lg mb-2">暂无监控策略</p>
                            <p class="text-gray-500 text-sm">
                                使用命令行工具添加策略：<br>
                                <code class="bg-gray-100 px-2 py-1 rounded mt-2 inline-block">python main.py --add-strategy</code>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Notifications Panel -->
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-4">
                        <h2 class="text-xl font-bold flex items-center">
                            📧 通知历史
                            <span v-if="notifications.length" class="ml-2 bg-green-400 text-xs px-2 py-1 rounded-full">
                                {{ notifications.length }}
                            </span>
                        </h2>
                    </div>
                    
                    <div class="p-6 max-h-96 overflow-y-auto custom-scrollbar">
                        <div v-if="notifications.length" class="space-y-3">
                            <div v-for="notification in notifications" :key="notification.id" 
                                 class="border-l-4 border-blue-400 bg-gray-50 p-3 rounded-r-lg hover:bg-gray-100 transition-colors">
                                <div class="text-xs text-gray-500 mb-1">{{ notification.sent_at }}</div>
                                <div class="text-sm leading-relaxed">{{ notification.message }}</div>
                                <div v-if="notification.strategy_name" class="text-xs text-blue-600 mt-1 font-medium">
                                    策略: {{ notification.strategy_name }}
                                </div>
                            </div>
                        </div>
                        
                        <div v-else class="text-center py-12">
                            <div class="text-gray-400 text-6xl mb-4">📧</div>
                            <p class="text-gray-600 text-lg mb-2">暂无通知记录</p>
                            <p class="text-gray-500 text-sm">
                                当策略触发时，通知记录会显示在这里
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Refresh Button -->
        <button @click="refreshData" 
                class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-110"
                :class="{'animate-spin': loading}"
                title="刷新数据">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
        </button>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    stats: {},
                    strategies: [],
                    notifications: [],
                    loading: false,
                    lastUpdate: null,
                    autoRefreshInterval: null
                }
            },
            
            methods: {
                async fetchData() {
                    this.loading = true;
                    try {
                        // Fetch all data in parallel
                        const [statsResponse, strategiesResponse, notificationsResponse] = await Promise.all([
                            fetch('/api/stats'),
                            fetch('/api/strategies'),
                            fetch('/api/notifications')
                        ]);

                        if (statsResponse.ok) {
                            this.stats = await statsResponse.json();
                        }
                        
                        if (strategiesResponse.ok) {
                            this.strategies = await strategiesResponse.json();
                        }
                        
                        if (notificationsResponse.ok) {
                            this.notifications = await notificationsResponse.json();
                        }

                        this.lastUpdate = new Date().toLocaleString('zh-CN');
                    } catch (error) {
                        console.error('获取数据失败:', error);
                    } finally {
                        this.loading = false;
                    }
                },

                async refreshData() {
                    await this.fetchData();
                },

                isDemo(strategy) {
                    return strategy.last_updated && strategy.last_updated.includes('演示数据');
                },

                getBadgeClass(action) {
                    const classes = {
                        'buy': 'bg-green-100 text-green-800',
                        'sell': 'bg-red-100 text-red-800',
                        'notify': 'bg-blue-100 text-blue-800'
                    };
                    return classes[action] || 'bg-gray-100 text-gray-800';
                },

                formatPrice(price) {
                    return parseFloat(price).toFixed(2);
                },

                formatTimestamp(timestamp) {
                    if (!timestamp) return '';
                    return timestamp.replace(' (演示数据)', '');
                },

                startAutoRefresh() {
                    // Auto refresh every 60 seconds
                    this.autoRefreshInterval = setInterval(() => {
                        this.fetchData();
                    }, 60000);
                },

                stopAutoRefresh() {
                    if (this.autoRefreshInterval) {
                        clearInterval(this.autoRefreshInterval);
                        this.autoRefreshInterval = null;
                    }
                }
            },

            async mounted() {
                console.log('🚀 股市监控系统已加载');
                await this.fetchData();
                this.startAutoRefresh();
            },

            beforeUnmount() {
                this.stopAutoRefresh();
            }
        }).mount('#app');
    </script>
</body>
</html>